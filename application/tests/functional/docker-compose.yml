version: "3.9"

services:
  postgres-test:
    container_name: postgres-test
    image: postgres:${PG_VERSION}-alpine
    restart: always
    environment:
      - POSTGRES_DB=${DB_NAME}
      - POSTGRES_USER=${DB_USER}
      - POSTGRES_PASSWORD=${DB_PASSWORD}

  redis-test:
    container_name: redis-test
    image: redis:${REDIS_VERSION}-alpine
    restart: always
    environment:
      - ALLOW_EMPTY_PASSWORD=yes
    env_file:
      - .env
    volumes:
      - ./redis:/data

  auth-api-test:
    container_name: flask-auth-api-test
    build:
      context: ../../
      dockerfile: Dockerfile
    env_file:
      - ../../../.env

    depends_on:
      - postgres-test
      - redis-test

  tests:
    container_name: test
    build:
      context: ../../
      dockerfile: ./tests/functional/Dockerfile
    env_file:
      - ../../../.env
    depends_on:
      - postgres-test
      - redis-test
